---
title: "Mediation Models"
output: html_document
---

#Read in libraries and data

```{r}
library(here)
library(tidyverse)
library(lavaan) 


setwd("/Users/laurenfinkelstein/Desktop/Arch Lab/COVID Appt Paper/Data")
data <-read.csv("CURRENT Full Covid Data.csv", header=T)

```

#Check data
```{r}

summary(data$cfi_mean_T1)
is.numeric(data$cfi_mean_T1)

summary(data$gad7_tot_T1)
is.numeric(data$gad7_tot_T1)

summary(data$phq8_tot_T1)
is.numeric(data$phq8_tot_T1)

summary(data$copefull_ACS_mean_T1 )
is.numeric(data$copefull_ACS_mean_T1)

summary(data$copefull_AvCS_mean_T1)
is.numeric(data$copefull_AvCS_mean_T1)

summary(data$Any_Self_Cancelled_Appt_T1)

```

#Generic mediation model
```{r}

contemporaneousMediationFit <- function(predictor_var, mediator_var, outcome_var) {

mediation.model.generic <- '

# a path
Mediator ~ a_path*Predictor

# b path
Outcome ~ b_path*Mediator

# c prime path
Outcome ~ cprime_path*Predictor



# tells lavaan to estimate the product of ab and its p value
ab := a_path*b_path

'
mediation.model <-  str_replace_all(mediation.model.generic,
                                     c("Outcome" = outcome_var,
                                       "Mediator" = mediator_var,
                                       "Predictor" = predictor_var))


# model is estimated
mediation.fit <- lavaan::sem(model = mediation.model,
            data = data,
            bootstrap = 1000,
            missing = 'listwise',
            link = 'probit',
            se = 'bootstrap',
            estimator = 'WLS',
            ordered = c('Any_Self_Cancelled_Appt_T1', 'Self_Cancelled_Screening_T1'))

return(mediation.fit)
}

```

#Time 1: Predictor = general COVID-19 fears, Outcome = any patient-cancelled appointment
```{r}

#Mediator = anxiety
set.seed(1)
General_Anx_Any <- contemporaneousMediationFit('cfi_mean_T1','gad7_tot_T1','Any_Self_Cancelled_Appt_T1')
summary(General_Anx_Any)

#Mediator = depression
set.seed(1)
General_Dep_Any <- contemporaneousMediationFit('cfi_mean_T1','phq8_tot_T1','Any_Self_Cancelled_Appt_T1')
summary(General_Dep_Any)

#Mediator = approach coping
set.seed(1)
General_Approach_Any <- contemporaneousMediationFit('cfi_mean_T1','copefull_ACS_mean_T1 ','Any_Self_Cancelled_Appt_T1')
summary(General_Approach_Any)

#Mediator = avoidance coping
set.seed(1)
General_Avoid_Any <- contemporaneousMediationFit('cfi_mean_T1','copefull_AvCS_mean_T1','Any_Self_Cancelled_Appt_T1')
summary(General_Avoid_Any)
```

#Time 1: Predictor = cancer-related COVID-19 fears, Outcome = any patient-cancelled appointment
```{r}
#Mediator = anxiety
set.seed(1)
Cancer_Anx_Any <- contemporaneousMediationFit('cfi_survivor_mean_T1','gad7_tot_T1','Any_Self_Cancelled_Appt_T1')
summary(Cancer_Anx_Any)

#Mediator = depression
set.seed(1)
Cancer_Dep_Any <- contemporaneousMediationFit('cfi_survivor_mean_T1','phq8_tot_T1','Any_Self_Cancelled_Appt_T1')
summary(Cancer_Dep_Any)

#Mediator = approach coping
set.seed(1)
Cancer_Approach_Any <- contemporaneousMediationFit('cfi_survivor_mean_T1','copefull_ACS_mean_T1 ','Any_Self_Cancelled_Appt_T1')
summary(Cancer_Approach_Any)

#Mediator = avoidance coping
set.seed(1)
Cancer_Avoid_Any <- contemporaneousMediationFit('cfi_survivor_mean_T1','copefull_AvCS_mean_T1','Any_Self_Cancelled_Appt_T1')
summary(Cancer_Avoid_Any)
```

#Time 1: C path
```{r}

contemporaneousUnmediatedFit <- function(predictor_var, outcome_var) {
  
  cpath.model.generic <- '
# c prime path
Outcome ~ c_path*Predictor
'
  cpath.model <-  str_replace_all(cpath.model.generic,
                                  c("Outcome" = outcome_var,
                                    "Predictor" = predictor_var))
  
  # model is estimated
  cpath.model.fit <- lavaan::sem(model = cpath.model,
            data = data,
            bootstrap = 1000,
            missing = 'listwise',
            link = 'probit',
            se = 'bootstrap',
            estimator = 'WLS',
            ordered = c('Any_Self_Cancelled_Appt_T1', 'Self_Cancelled_Screening_T1'))
  
  return(cpath.model.fit)
}  

#Outcome = any patient-cancelled appointment
set.seed(1)
cpath_General_Any <- contemporaneousUnmediatedFit('cfi_mean_T1','Any_Self_Cancelled_Appt_T1')
summary(cpath_General_Any)

set.seed(1)
cpath_Cancer_Any <- contemporaneousUnmediatedFit('cfi_survivor_mean_T1','Any_Self_Cancelled_Appt_T1')
summary(cpath_Cancer_Any)

#Outcome = patient-cancelled cancer screening
set.seed(1)
cpath_General_Screen <- contemporaneousUnmediatedFit('cfi_mean_T1','Self_Cancelled_Screening_T1')
summary(cpath_General_Screen)

set.seed(1)
cpath_Cancer_Screen <- contemporaneousUnmediatedFit('cfi_survivor_mean_T1','Self_Cancelled_Screening_T1')
summary(cpath_Cancer_Screen)

  
```
#Create true/false variable for any patient-cancelled cancer screening
```{r}
data <- 
  data %>%
  
  mutate(adh_cancer_test_T1 = factor(adh_cancer_test_T1,
                                     levels = c(0,1,2,3),
                                       labels = c('No','Yes', 'Not sure', 'I did not have anything scheduled')),
                  adh_cancer_test_T2 = factor(adh_cancer_test_T2,
                                     levels = c(0,1,2,3),
                                       labels = c('No','Yes', 'Not sure', 'I did not have anything scheduled')),
                  adh_cancer_test_T3 = factor(adh_cancer_test_T3,
                                     levels = c(0,1,2,3),
                                    labels = c('No','Yes', 'Not sure', 'I did not have anything scheduled')),
         adh_cancer_you_T1 = factor(adh_cancer_you_T1,
                                         levels = c(0,1,2,3),
                                         labels = c('No','Yes','Not Sure', 'I did not have anything scheduled')),
         adh_cancer_you_T2 = factor(adh_cancer_you_T2,
                                         levels = c(0,1,2,3),
                                         labels = c('No','Yes','Not Sure', 'I did not have anything scheduled')),
         adh_cancer_you_T3 = factor(adh_cancer_you_T3,
                                         levels = c(0,1,2,3),
                                         labels = c('No','Yes','Not Sure', 'I did not have anything scheduled')),
    adh_cancer_test_who_T1 = fct_explicit_na(factor(adh_cancer_test_who_T1,
                                         levels = c(1,2),
                                         labels = c('Me','My healthcare provider'))),
         adh_cancer_test_who_T2 = fct_explicit_na(factor(adh_cancer_test_who_T2,
                                         levels = c(1,2),
                                         labels = c('Me','My healthcare provider'))),
         adh_cancer_test_who_T3 = fct_explicit_na(factor(adh_cancer_test_who_T3,
                                         levels = c(1,2),
                                         labels = c('Me','My healthcare provider'))))


data <-
  data %>%
  mutate(Self_Cancelled_Screening_T1 = (adh_cancer_test_who_T1 == "Me"),
         Self_Cancelled_Screening_T2 = (adh_cancer_test_who_T2 == "Me"),
         Self_Cancelled_Screening_T3 = (adh_cancer_test_who_T3 == "Me"))

table(data$Self_Cancelled_Screening_T1)
table(data$Self_Cancelled_Screening_T2)
table(data$Self_Cancelled_Screening_T3)

```

#Time 1: Predictor = general COVID-19 fears, Outcome = patient-cancelled cancer screening
```{r}

#Mediator = anxiety
set.seed(1)
General_Anx_Screen <- contemporaneousMediationFit('cfi_mean_T1','gad7_tot_T1','Self_Cancelled_Screening_T1')
summary(General_Anx_Screen)

#Mediator = depression
set.seed(1)
General_Dep_Screen <- contemporaneousMediationFit('cfi_mean_T1','phq8_tot_T1','Self_Cancelled_Screening_T1')
summary(General_Dep_Screen)

#Mediator = approach coping
set.seed(1)
General_Approach_Screen <- contemporaneousMediationFit('cfi_mean_T1','copefull_ACS_mean_T1 ','Self_Cancelled_Screening_T1')
summary(General_Approach_Screen)

#Mediator = avoidance coping
set.seed(1)
General_Avoid_Screen <- contemporaneousMediationFit('cfi_mean_T1','copefull_AvCS_mean_T1','Self_Cancelled_Screening_T1')
summary(General_Avoid_Screen)

```
#Time 1: Predictor = cancer-related COVID-19 fears, Outcome = patient-cancelled cancer screening
```{r}
#Mediator = anxiety
set.seed(1)
Cancer_Anx_Screen <- contemporaneousMediationFit('cfi_survivor_mean_T1','gad7_tot_T1','Self_Cancelled_Screening_T1')
summary(Cancer_Anx_Screen)

#Mediator = depression
set.seed(1)
Cancer_Dep_Screen <- contemporaneousMediationFit('cfi_survivor_mean_T1','phq8_tot_T1','Self_Cancelled_Screening_T1')
summary(Cancer_Dep_Screen)

#Mediator = approach coping
set.seed(1)
Cancer_Approach_Screen <- contemporaneousMediationFit('cfi_survivor_mean_T1','copefull_ACS_mean_T1 ','Self_Cancelled_Screening_T1')
summary(Cancer_Approach_Screen)

#Mediator = avoidance coping
set.seed(1)
Cancer_Avoid_Screen <- contemporaneousMediationFit('cfi_survivor_mean_T1','copefull_AvCS_mean_T1','Self_Cancelled_Screening_T1')
summary(Cancer_Avoid_Screen)
```

