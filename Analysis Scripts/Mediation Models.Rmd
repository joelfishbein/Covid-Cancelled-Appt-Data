---
title: "Mediation Models"
output: html_document
---

#Read in libraries and data

```{r}
library(here)
library(tidyverse)
library(lavaan) 


setwd("/Users/laurenfinkelstein/Desktop/Arch Lab/COVID Appt Paper/Data")
data <-read.csv("CURRENT Full Covid Data.csv", header=T)

```

#Check data
```{r}

summary(data$cfi_mean_T1)
is.numeric(data$cfi_mean_T1)

summary(data$gad7_tot_T1)
is.numeric(data$gad7_tot_T1)

summary(data$phq8_tot_T1)
is.numeric(data$phq8_tot_T1)

summary(data$copefull_ACS_mean_T1 )
is.numeric(data$copefull_ACS_mean_T1)

summary(data$copefull_AvCS_mean_T1)
is.numeric(data$copefull_AvCS_mean_T1)

summary(data$Any_Self_Cancelled_Appt_T1)



```

#Generic mediation model
```{r}

contemporaneousMediationFit <- function(predictor_var, mediator_var, outcome_var) {

mediation.model.generic <- '

# a path
Mediator ~ a_path*Predictor

# b path
Outcome ~ b_path*Mediator

# c prime path
Outcome ~ cprime_path*Predictor



# tells lavaan to estimate the product of ab and its standard error and p value
ab := a_path*b_path

'
mediation.model <-  str_replace_all(mediation.model.generic,
                                     c("Outcome" = outcome_var,
                                       "Mediator" = mediator_var,
                                       "Predictor" = predictor_var))


# model is estimated
mediation.fit <- lavaan::sem(model = mediation.model,
            data = data,
            bootstrap = 1000,
            missing = 'listwise',
            link = 'probit',
            se = 'bootstrap',
            estimator = 'WLS',
            ordered = c('Any_Self_Cancelled_Appt_T1'))

return(mediation.fit)
}

```

#Predictor = general COVID-19 fears, Outcome = any patient-cancelled appointment
```{r}

#Mediator = anxiety
set.seed(1)
General_Anx_Any <- contemporaneousMediationFit('cfi_mean_T1','gad7_tot_T1','Any_Self_Cancelled_Appt_T1')
summary(General_Anx_Any)

#Mediator = depression
set.seed(1)
General_Dep_Any <- contemporaneousMediationFit('cfi_mean_T1','phq8_tot_T1','Any_Self_Cancelled_Appt_T1')
summary(General_Dep_Any)

#Mediator = approach coping
set.seed(1)
General_Approach_Any <- contemporaneousMediationFit('cfi_mean_T1','copefull_ACS_mean_T1 ','Any_Self_Cancelled_Appt_T1')
summary(General_Approach_Any)

#Mediator = avoidance coping
set.seed(1)
General_Avoid_Any <- contemporaneousMediationFit('cfi_mean_T1','copefull_AvCS_mean_T1','Any_Self_Cancelled_Appt_T1')
summary(General_Avoid_Any)
```

#Predictor = cancer-related COVID-19 fears, Outcome = any patient-cancelled appointment
```{r}
#Mediator = anxiety
set.seed(1)
Cancer_Anx_Any <- contemporaneousMediationFit('cfi_survivor_mean_T1','gad7_tot_T1','Any_Self_Cancelled_Appt_T1')
summary(Cancer_Anx_Any)

#Mediator = depression
set.seed(1)
Cancer_Dep_Any <- contemporaneousMediationFit('cfi_survivor_mean_T1','phq8_tot_T1','Any_Self_Cancelled_Appt_T1')
summary(Cancer_Dep_Any)

#Mediator = approach coping
set.seed(1)
Cancer_Approach_Any <- contemporaneousMediationFit('cfi_survivor_mean_T1','copefull_ACS_mean_T1 ','Any_Self_Cancelled_Appt_T1')
summary(Cancer_Approach_Any)

#Mediator = avoidance coping
set.seed(1)
Cancer_Avoid_Any <- contemporaneousMediationFit('cfi_survivor_mean_T1','copefull_AvCS_mean_T1','Any_Self_Cancelled_Appt_T1')
summary(Cancer_Avoid_Any)
```

#C path
```{r}

contemporaneousUnmediatedFit <- function(predictor_var, outcome_var) {
  
  cpath.model.generic <- '
# c prime path
Outcome ~ c_path*Predictor
'
  cpath.model <-  str_replace_all(cpath.model.generic,
                                  c("Outcome" = outcome_var,
                                    "Predictor" = predictor_var))
  
  # model is estimated
  cpath.model.fit <- lavaan::sem(model = cpath.model,
            data = data,
            bootstrap = 1000,
            missing = 'listwise',
            link = 'probit',
            se = 'bootstrap',
            estimator = 'WLS',
            ordered = c('Any_Self_Cancelled_Appt_T1'))
  
  return(cpath.model.fit)
}  

set.seed(1)
cpath_General_Any <- contemporaneousUnmediatedFit('cfi_mean_T1','Any_Self_Cancelled_Appt_T1')
summary(cpath_General_Any)

set.seed(1)
cpath_Cancer_Any <- contemporaneousUnmediatedFit('cfi_survivor_mean_T1','Any_Self_Cancelled_Appt_T1')
summary(cpath_Cancer_Any)
  
```

#T1 models for outcome = any patient-cancelled appointment
`

