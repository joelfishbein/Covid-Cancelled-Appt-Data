---
title: "Compare counts of self- and provider-cancelled appts at the three timepoints"
output:
  pdf_document: default
  html_notebook: default
---

```{r include=FALSE}
library(tidyverse)
library(here)
library(pander)

```


```{r include=FALSE}
  
data <- read_rds(here("Generated data","data_with_correct_summary_cancellation_variables.rds"))
  
```

# Generic function for formatting the data correctly and running McNemar's test

Approach to set up McNemar's test with table() used here is adapted from https://www.r-bloggers.com/2021/06/paired-test-for-dichotomous-data-mcnemars-test-in-r/

```{r}

setupMcNemarsTest <- function(var1, var2) {
  
  # remove cases with missing data at either timepoint
  my_data <- tibble(var1, var2) %>%
    filter(!is.na(var1)) %>%
    filter(!is.na(var2))
  
  
  
  data_table <- table(my_data$var1, my_data$var2)
  
  return(data_table)
  
}

```

# Self cancelled appts

## T1 with T2

```{r echo=FALSE}

setupMcNemarsTest(data$Any_Self_Cancelled_Appt_T1, data$Any_Self_Cancelled_Appt_T2) %>%
  mcnemar.test()

 
setupMcNemarsTest(data$Any_Self_Cancelled_Appt_T1, data$Any_Self_Cancelled_Appt_T2) %>% 
  kableExtra::kable(col.names = c('No self-cancelled appointments','Had self-cancelled appointments')) %>%
  kableExtra::kable_classic(html_font = 'Times New Roman', full_width=FALSE) %>%
  group_rows(group_label = 'Time X', start_row = 1, end_row = 2, bold = FALSE) %>%
  kableExtra::add_header_above(c(" " = 1, 'Time X' = 2 ))
```


## T2 with T3

```{r echo=FALSE}

setupMcNemarsTest(data$Any_Self_Cancelled_Appt_T2, data$Any_Self_Cancelled_Appt_T3) %>%
  mcnemar.test()

setupMcNemarsTest(data$Any_Self_Cancelled_Appt_T2, data$Any_Self_Cancelled_Appt_T3) %>% 
  kableExtra::kable(col.names = c('No self-cancelled appointments','Had self-cancelled appointments')) %>%
  kableExtra::kable_classic(html_font = 'Times New Roman', full_width=FALSE) %>%
  group_rows(group_label = 'Time X', start_row = 1, end_row = 2, bold = FALSE) %>%
  kableExtra::add_header_above(c(" " = 1, 'Time X' = 2 ))
```

## T1 with T3

```{r echo=FALSE}

setupMcNemarsTest(data$Any_Self_Cancelled_Appt_T1, data$Any_Self_Cancelled_Appt_T3) %>%
  mcnemar.test()

table(data$Any_Self_Cancelled_Appt_T3, useNA = "ifany")
```

# Provider cancelled appts
## T1 with T2

```{r echo=FALSE}

setupMcNemarsTest(data$Any_Provider_Cancelled_Appt_T1, data$Any_Provider_Cancelled_Appt_T2) %>%
  mcnemar.test()

setupMcNemarsTest(data$Any_Provider_Cancelled_Appt_T1, data$Any_Provider_Cancelled_Appt_T2) %>% 
  kableExtra::kable(col.names = c('No provider-cancelled appointments','Had provider-cancelled appointments')) %>%
  kableExtra::kable_classic(html_font = 'Times New Roman', full_width=FALSE) %>%
  group_rows(group_label = 'Time X', start_row = 1, end_row = 2, bold = FALSE) %>%
  kableExtra::add_header_above(c(" " = 1, 'Time X' = 2 ))

```


## T2 with T3

```{r echo=FALSE}

setupMcNemarsTest(data$Any_Provider_Cancelled_Appt_T2, data$Any_Provider_Cancelled_Appt_T3) %>%
  mcnemar.test()

setupMcNemarsTest(data$Any_Provider_Cancelled_Appt_T2, data$Any_Provider_Cancelled_Appt_T3) %>% 
  kableExtra::kable(col.names = c('No provider-cancelled appointments','Had provider-cancelled appointments')) %>%
  kableExtra::kable_classic(html_font = 'Times New Roman', full_width=FALSE) %>%
  group_rows(group_label = 'Time X', start_row = 1, end_row = 2, bold = FALSE) %>%
  kableExtra::add_header_above(c(" " = 1, 'Time X' = 2 ))

```

## T1 with T3

```{r echo=FALSE}

setupMcNemarsTest(data$Any_Provider_Cancelled_Appt_T1, data$Any_Provider_Cancelled_Appt_T3) %>%
  mcnemar.test()

```


