---
title: "R Notebook"
author: "Joel Fishbein"
date: "March 1 2021"
output:
  html_document:
    df_print: paged
  pdf_document: default
description: This script produces a table with the mediation model output for the
  Valued Living Study causal steps mediation analysis.
---

This script produces a table with the mediation model output for the Valued Living Study causal steps mediation analysis.


# Setup

```{r}

library(tidyverse)
library(here)
library(kableExtra)

load(file = here('4 Generated Datasets','PrePost_mediation_models.RData'))

# drop the functions so that the mapping works
rm(contemporaneousMediationFit)
rm(contemporaneousUnmediatedFit)
rm(getMyParameterEstimates)

# drop unmediated models that are in the environment
rm(HADS.A._contemporaneous_unmediated.fit)
rm(FearOfRecurrence_contemporaneous_unmediated.fit)
rm(IES.Total_contemporaneous_unmediated.fit)


```



# Tidy up model estimates

```{r}

# write everything into one list 
# so that purrr() library can be used
models <-
mget(ls()) %>% 
  list()

# tidy every model
tidy_model_output <-
models[[1]] %>%
purrr::map(broom::tidy)



getPaths <- function(tidy_lavaan_fit){
  
  tidy_lavaan_fit %>%
  filter(label %in% c('mediator_change_mean','mediator_variance',
                      'outcome_change_mean','outcome_variance',
                      'a_path','b_path','cprime_path','ab','effect_size'))}

myPaths <-
tidy_model_output %>%
  map(getPaths)

myPaths
```

# Extract model information

```{r}

estimates <-
myPaths %>%
  map_df(c('estimate')) %>%
  t() %>%
  magrittr::set_colnames(c('a_estimate','b_estimate', 'cprime_estimate',
                           'mediator.mean_estimate', 'outcome.mean_estimate',
                           'mediator.variance_estimate', 'outcome.variance_estimate',
                           'ab_estimate', 'es_estimate')) %>%
  as_tibble(rownames = 'model')

standard_errors <-
myPaths %>%
  map_df(c('std.error')) %>%
  t() %>%
  magrittr::set_colnames(c('a_stderr','b_stderr','cprime_stderr',
                           'mediator.mean_stderr', 'outcome.mean_stderr',
                           'mediator.variance_stderr', 'outcome.variance_stderr',
                           'ab_stderr','es_stderr')) %>%
  as_tibble(rownames = 'model')

p_values <-
myPaths %>%
  map_df(c('p.value')) %>%
  t()%>%
  magrittr::set_colnames(c('a_pval','b_pval','cprime_pval',
                           'mediator.mean_pval', 'outcome.mean_pval',
                           'mediator.variance_pval', 'outcome.variance_pval',
                           'ab_pval','es_pval')) %>%
  as_tibble(rownames = 'model')



```

## Combine everything into one table and format for printing

### Create function for formatting p values

```{r}

formatPValue <- function(my_p_value) {
  
  my_p_value_rounded <- format(round(my_p_value, 3), nsmall = 3)
  
  my_p_value_string <- as.character(my_p_value_rounded)
  
  my_p_value_drop_zero <- stringr::str_replace(string = my_p_value_string, pattern = "0.", replacement = ".")
  
  my_p_value_fully_formatted <- stringr::str_replace(string = my_p_value_drop_zero, pattern = ".000", replacement = "<.001")
  
  return(my_p_value_fully_formatted)
}

# test that this works - appears it does
# cbind(p_values$a_pval, format(round(p_values$a_pval, 3), nsmall = 3), formatPValue(p_values$a_pval))

```


### Make table

```{r}
my_estimates_table <- 
  
  # join all the statistics
  left_join(estimates, standard_errors, by = "model") %>%
  left_join(p_values, by = "model") %>%
  
  # rearrange order for convenience
  # we are not analyzing effect sizes in this table so those are dropped
  select(model, outcome.mean_estimate, outcome.mean_stderr, outcome.mean_pval,
         outcome.variance_estimate, outcome.variance_stderr, outcome.variance_pval,
         mediator.mean_estimate, mediator.mean_stderr, mediator.mean_pval,
         mediator.variance_estimate, mediator.variance_stderr, mediator.variance_pval,
         a_estimate, a_stderr, a_pval,
         b_estimate, b_stderr, b_pval,
         cprime_estimate, cprime_stderr, cprime_pval,
         ab_estimate, ab_stderr, ab_pval) %>%
  
  
 
  
  # split the "model" column so that one string column
  # contains the name of the mediator, and another the outcome
  
  separate(col = model,
           into = c('mediator_var','outcome_var','contemporaneous_or_lagged'), 
           sep = '_') %>%
  
  # not using these variables so delete them for now
  select(-contemporaneous_or_lagged) %>%
  
  # do some more tidying of the variable names
  mutate(outcome_var = str_replace_all(string = outcome_var,
                                  c( "\\." = " ",
                                    "FearOfRecurrence" = "CARS",
                                    "IES Total" = "IES"))) %>%
  
  mutate(mediator_var = str_replace_all(string = mediator_var,
                                  c("_Post_minus_Pre" = "",
                                    "\\." = " ",
                                    "SelfCompassion" = "SCS",
                                    "EAC Mean" = "EAC"))) %>%
  
  # round to 2 decimals
    mutate(across(
    c(outcome.mean_estimate, outcome.mean_stderr,outcome.variance_estimate, outcome.variance_stderr,
      mediator.mean_estimate, mediator.mean_stderr,
       mediator.variance_estimate, mediator.variance_stderr,
      a_estimate, a_stderr, b_estimate, b_stderr, cprime_estimate, cprime_stderr, ab_estimate, ab_stderr), 
    
    # format forces the rounding to keep trailing zeros
    ~format(round(.x, digits =  2), nsmall = 2))) %>%
  
  # format p values to drop leading zero, convert .000 to <.001
  mutate(across(
    c(outcome.mean_pval, outcome.variance_pval,
      mediator.mean_pval, mediator.variance_pval,
      a_pval, b_pval, cprime_pval, ab_pval),
        ~formatPValue(.x)))
  
```

# DEPR-Get counts of number of observations per difference score

```{r}

# load in data
# differenceScoresData <- readRDS(here('Data','difference_scores_dataset.rds'))

```


```{r}
# 
# # store counts
# num_obs_present <-
# 
# differenceScoresData %>%
#   
#   pivot_longer(cols = HADS.A_Post_minus_Pre:EAC.Mean_SixMonthFU_minus_Pre,
#                names_to = 'variable') %>%
#   
#   group_by(variable) %>%
#   
#   summarise(num_present = sum(!is.na(value)),
#             num_missing = sum(is.na(value)))

```

## Get the counts per row into the estimates table

```{r}
# 
# # first join and get the right counts for the mediator variables
# my_estimates_table_with_counts <- left_join(x = my_estimates_table, 
#                                             y = num_obs_present,
#                                             by = c("mediator_var" =  "variable")) %>%
#   rename(observations_present_of_mediator = num_present,
#          observations_missing_of_mediator = num_missing) %>%
#   
#   # now join again but matching by outcome variable
#   left_join(y = num_obs_present,
#             by = c("outcome_var" =  "variable")) %>% 
#     rename(observations_present_of_outcome = num_present,
#          observations_missing_of_outcome = num_missing)  %>%
#   
#   # re-order columns for convenience
#   relocate(observations_present_of_mediator:observations_missing_of_mediator,
#            .after = mediator_var) %>%
#   
#     relocate(observations_present_of_outcome:observations_missing_of_outcome,
#            .after = outcome_var)
#          

```



# Re-format to match BRaT initial submission table

## Reorder so it is IES-R, then FCR, then HADS-A

```{r}

my_estimates_table_sorted <-

  my_estimates_table%>%

  mutate(outcome_var = factor(outcome_var,
                                 levels = c('IES','FCR','HADS A'))) %>%
  
  arrange(outcome_var)

my_estimates_table_sorted


```


## Pivot correctly

```{r}

my_estimates_table_reformatted.tidy <-
  my_estimates_table_sorted %>%
  pivot_longer(cols = (outcome.mean_estimate: ab_pval),
               names_to = c('parameter','statistic'),
               names_sep = '_')

my_estimates_table_reformatted.wider <-
  my_estimates_table_reformatted.tidy %>%
  pivot_wider(values_from = value,
              names_from = c(mediator_var,statistic),
              names_sep = "_") %>%
  mutate(BEAQ_estimate_SE = str_c(BEAQ_estimate, '\n (',BEAQ_stderr,')'),
         AAQc_estimate_SE = str_c(AAQc_estimate, '\n (',AAQc_stderr,')'),
         Bullseye_estimate_SE = str_c(Bullseye_estimate, ' \n (',Bullseye_stderr,')'),
         VLQ_estimate_SE = str_c(VLQ_estimate, '\n (',VLQ_stderr,')'),
         SCS_estimate_SE = str_c(SCS_estimate, 
                                            '\n (',SCS_stderr,')'),
         EAC_estimate_SE = str_c(EAC_estimate, '\n (',EAC_stderr,')')) %>%
  select(outcome_var, parameter, AAQc_estimate_SE, AAQc_pval, BEAQ_estimate_SE, BEAQ_pval,
         Bullseye_estimate_SE, Bullseye_pval, VLQ_estimate_SE, VLQ_pval,
         SCS_estimate_SE, SCS_pval, EAC_estimate_SE, EAC_pval) %>%
  relocate(BEAQ_estimate_SE, .before = AAQc_estimate_SE) %>%
  relocate(BEAQ_pval, .before = AAQc_estimate_SE) %>%
  
  # rename parameters
  mutate(parameter = stringr::str_replace_all(string = parameter, c("cprime" = "c",
                                                                    "outcome.mean" = "Outcome Pre-Post M",
                                                                    "outcome.variance" = "Outcome Pre-Post Var",
                                                                    "mediator.mean" = "Mediator Pre-Post M",
                                                                    "mediator.variance" = "Mediator Pre-Post Var")))


my_estimates_table_reformatted.wider
```

## Output with kable

Things to change (wasn't clear how to yet):
- Italicize "p"
- Make "p" column three decimal places

```{r}
knitr::kable(my_estimates_table_reformatted.wider, 
             caption = 'Mediation model path estimates',
             format = 'html',
             col.names = c('Outcome', 'Parameter',
                           rep(c('Estimate (SE)',"p"),6))) %>%
  
  kable_classic(html_font = 'Times New Roman', full_width = FALSE) %>%
  
  # custom edit the outcome mediator and outcome 
  # variable name columns so they display nicely on one line
  
  # remove outcome name
  remove_column(column = 1) %>%
  
  # force columns to be narrower
  column_spec(column = c(1:13), width = "10em") %>% 
  
  # center everything
  row_spec(row = c(0:24), extra_css = "text-align: center;") %>%

  
  add_header_above(c(" " = 1,
                     "BEAQ" = 2, 
                     "AAQc" = 2, 
                     "Bullseye" = 2, 
                     "VLQ" = 2, 
                     "SCS" = 2,
                     'EAC' = 2), extra_css = "text-align: center;") %>%
  
    add_header_above(c(" " = 1,
                     "Core ACT Processes" = 8, 
                     "Broader ACT-Consistent Processes" = 4), extra_css = "text-align: center;") %>%
  
    pack_rows("Outcome = Cancer-Related Trauma Symptoms (IES-R)", 1, 8, label_row_css = "text-align: center; font-weight: normal;") %>%
  pack_rows("Outcome = Fear of Recurrence (CARS)", 9, 16, label_row_css = "text-align: center; font-weight: normal;") %>%
  pack_rows("Outcome = General Anxiety Symptoms (HADS-A)", 17, 24, label_row_css = "text-align: center; font-weight: normal;")
  

```

OUTPUT: knit to HTML, then copy into Word. This allows the table to show up as editable in Word.

# Manually inspect model fits just to confirm the table looks correct

6-28-21, I will visually inspect one fit per mediator using the function I wrote and compare to what is in Table 1 in the main manuscript to make sure it matches

They all look correct.

```{r}

inspectFit <- function(my.fit){
  lavaan::parameterEstimates(my.fit) %>%
  filter(label != "") %>%
  select(label, est, se, pvalue) %>%
  mutate(est = round(est,2),
         se = round(se, 2))
}

# this one looks correct
inspectFit(BEAQ_HADS.A_contemporaneous.fit)

# this one looks correct
inspectFit(AAQc_FCR_contemporaneous.fit)

# this one looks correct
inspectFit(Bullseye_IES.Total_contemporaneous.fit)

# this one looks correct
inspectFit(VLQ_FCR_contemporaneous.fit)

# this one looks correct
inspectFit(SelfCompassion_HADS.A_contemporaneous.fit)

# this one looks correct
inspectFit(EAC.Mean_IES.Total_contemporaneous.fit)

```



