---
title: "Single mediation models"
author: Joel Fishbein
date: June 28 2021
output: html_notebook
license: CC-By Attribution 4.0 International - Joel Fishbein
---


I recommend opening this R Markdown file in Rstudio for full functionality.

This script runs single mediation models for the Valued Living RCT.

The data read in from mediator_differences_scores_wide.rds are difference scores (Post-intvention score minus Pre-intervention score, aka Post_minus_Pre) for each outcome and mediator variable.

There is also a condition variable, condCC, that codes which study arm each participant was randomized to: -0.5 = minimally enhacned usual care (MEUC),
0.5 = ACT.

The data contain one row per participant.


# Read in data and libraries
```{r, include=FALSE} 
library(here)
library(tidyverse)
library(lavaan) 


mediator_difference_scores.wide <- readr::read_rds(
  here('Data', 'difference_scores_dataset.rds'))


```


## Define function for looking at parameter estimates

```{r}

getMyParameterEstimates <- function(my.fit) {
  
 broom::tidy(my.fit) %>%
    filter(label != "") %>%
    select(label, estimate, std.error, p.value) %>%
    mutate(across(c(estimate, std.error), ~round(.x, 2))) %>%
    mutate(p.value = round(p.value, 3))
  
}
```

# Mediation model functions

A generic mediation model is specified. 
Then, the actual variable names are substituted into the syntax.
Finally, the model is estimated and output is requested.

This method ensures that the same model will be estimated for each mediator-outcome variable pair (e.g., no typos that could result from copy/pasting the same syntax and making minor changes numerous times).

The syntax for the model is adapted from:

Montoya, A. K. (2018). Conditional Process Analysis in Two-Instance Repeated-Measures Designs [Dissertation, The Ohio State University]. http://rave.ohiolink.edu/etdc/view?acc_num=osu1530904232127584

## Contemporaneous Mediation Model
```{r}


# syntax for the mediation model
# a, b and cprime are freely estimated and
# labeled for convenience of viewing the output,
#and to allow for computation of ab at the end of the syntax

contemporaneousMediationFit <- function(mediator_var, outcome_var) {

mediation.model.generic <- '

# a path
Mediator_Post_minus_Pre ~ a_path*participant_condCC

# b path
Outcome_Post_minus_Pre ~ b_path*Mediator_Post_minus_Pre

# c prime path
Outcome_Post_minus_Pre ~ cprime_path*participant_condCC

# estimate means
Mediator_Post_minus_Pre ~ mediator_change_mean*1
Outcome_Post_minus_Pre ~ outcome_change_mean*1

# estimate variances
Mediator_Post_minus_Pre ~~ mediator_variance*Mediator_Post_minus_Pre
Outcome_Post_minus_Pre ~~ outcome_variance*Outcome_Post_minus_Pre


# tells lavaan to estimate the product of ab and its standard error and p value
ab := a_path*b_path

effect_size := ab/sqrt(outcome_variance)

'

# this line inserts the actual variable names into the model syntax
# as specified above
mediation.model <-  str_replace_all(mediation.model.generic,
                                     c("Outcome" = outcome_var,
                                       "Mediator" = mediator_var))

# model is estimated
mediation.fit <- lavaan::sem(model = mediation.model,
           data = mediator_difference_scores.wide,
            bootstrap = 1000,
            se = 'bootstrap',
           missing = 'fiml')

return(mediation.fit)
}

```



## Contemporaneous c path model

```{r}

contemporaneousUnmediatedFit <- function(outcome_var) {
  
  cpath.model.generic <- '


# c prime path
Outcome_Post_minus_Pre ~ c_path*participant_condCC

Outcome_Post_minus_Pre ~ outcome_change_mean*1

Outcome_Post_minus_Pre ~~ outcome_variance*Outcome_Post_minus_Pre

'
  
  # this line inserts the actual variable names into the model syntax
  # as specified above
  cpath.model <-  str_replace_all(cpath.model.generic,
                                  c("Outcome" = outcome_var))
  
  # model is estimated
  cpath.model.fit <- lavaan::sem(model = cpath.model,
                                 data = mediator_difference_scores.wide,
                                 bootstrap = 1000,
                                 se = 'bootstrap',
                                 missing = 'fiml')
  
  return(cpath.model.fit)
}

```








# Estimate models and save output

## Unmediated Models

```{r}
set.seed(1)
HADS.A._contemporaneous_unmediated.fit <- contemporaneousUnmediatedFit('HADS.A')

set.seed(1)
IES.Total_contemporaneous_unmediated.fit <- contemporaneousUnmediatedFit('IES.Total')

set.seed(1)
FearOfRecurrence_contemporaneous_unmediated.fit <- contemporaneousUnmediatedFit('FearOfRecurrence')

```

## EAC Models
```{r}
set.seed(1)
EAC.Mean_IES.Total_contemporaneous.fit <- contemporaneousMediationFit('EAC.Mean','IES.Total')

set.seed(1)
EAC.Mean_FCR_contemporaneous.fit <- contemporaneousMediationFit('EAC.Mean','FearOfRecurrence')
getMyParameterEstimates(EAC.Mean_FCR_contemporaneous.fit )


set.seed(1)
EAC.Mean_HADS.A_contemporaneous.fit <- contemporaneousMediationFit('EAC.Mean','HADS.A')
getMyParameterEstimates(EAC.Mean_HADS.A_contemporaneous.fit)


```
## SelfCompassion Models
```{r}

set.seed(1)
SelfCompassion_IES.Total_contemporaneous.fit <- contemporaneousMediationFit('SelfCompassion','IES.Total')

set.seed(1)
SelfCompassion_FCR_contemporaneous.fit <- contemporaneousMediationFit('SelfCompassion','FearOfRecurrence')

set.seed(1)
SelfCompassion_HADS.A_contemporaneous.fit <- contemporaneousMediationFit('SelfCompassion','HADS.A')


```



## VLQ Models
```{r}
set.seed(1)
VLQ_IES.Total_contemporaneous.fit <- contemporaneousMediationFit('VLQ','IES.Total')

set.seed(1)
VLQ_FCR_contemporaneous.fit <- contemporaneousMediationFit('VLQ','FearOfRecurrence')

set.seed(1)
VLQ_HADS.A_contemporaneous.fit <- contemporaneousMediationFit('VLQ','HADS.A')


```

## Bullseye Models
```{r}
set.seed(1)
Bullseye_IES.Total_contemporaneous.fit <- contemporaneousMediationFit('Bullseye','IES.Total')

set.seed(1)
Bullseye_FCR_contemporaneous.fit <- contemporaneousMediationFit('Bullseye','FearOfRecurrence')

set.seed(1)
Bullseye_HADS.A_contemporaneous.fit <- contemporaneousMediationFit('Bullseye','HADS.A')


```

## AAQc Models
```{r}
set.seed(1)
AAQc_IES.Total_contemporaneous.fit <- contemporaneousMediationFit('AAQc','IES.Total')

set.seed(1)
AAQc_FCR_contemporaneous.fit <- contemporaneousMediationFit('AAQc','FearOfRecurrence')

set.seed(1)
AAQc_HADS.A_contemporaneous.fit <- contemporaneousMediationFit('AAQc','HADS.A')


```

## BEAQ Models
```{r}
set.seed(1)
BEAQ_IES.Total_contemporaneous.fit <- contemporaneousMediationFit('BEAQ','IES.Total')

set.seed(1)
BEAQ_FCR_contemporaneous.fit <- contemporaneousMediationFit('BEAQ','FearOfRecurrence')

set.seed(1)
BEAQ_HADS.A_contemporaneous.fit <- contemporaneousMediationFit('BEAQ','HADS.A')


```

# save model output to a file

Since these models take a long time to run,
save the actual output.

```{r}

# remove this object from the environment
# so that individual scores are not saved alongside the models
rm(mediator_difference_scores.wide)

# save the rest of the workspace, which is now just lavaan fit models
# and the generic functions
save.image(file = here('4 Generated Datasets', 'PrePost_mediation_models.RData'))

```
